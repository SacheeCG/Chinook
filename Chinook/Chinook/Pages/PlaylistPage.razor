@page "/playlist/{PlaylistId:long}"
@attribute [Authorize]
@inject UserService UserService
@inject PlaylistService PlaylistService
@inject ArtistService ArtistService
@inject NavMenuService NavMenuService



@using Chinook.ClientModels;
@using Chinook.Models
@using Chinook.Services;
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims;

<h1>Playlist <strong>@FavoritePlaylist.Name</strong></h1>

@if (!string.IsNullOrWhiteSpace(InfoMessage))
{
    <div class="alert alert-info fade show">
        <div class="d-flex align-items-start">
            <div class="flex-grow-1">
                @InfoMessage
            </div>
            <button type="button" class="btn-close" aria-label="Close" @onclick="CloseInfoMessage"></button>
        </div>
    </div>
}

@if (FavoritePlaylist == null)
{
    <Loading />
}
else
{
    <table class="table table-striped table-hover table-sm">
        <thead>
            <tr>
                <th>Track</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @if (FavoritePlaylist.Tracks != null)
            {
                @foreach (var track in FavoritePlaylist.Tracks)
                {
                    <tr>
                        <td>@Album.Where(x=>x.AlbumId == @track.AlbumId).Select(x=>x.Artist.Name).FirstOrDefault() - @Album.Where(x=>x.AlbumId == @track.AlbumId).Select(x=>x.Title).FirstOrDefault() - @track.Name</td>
                        <td>
                            <div class="d-flex">
                                @if (FavoritePlaylist.Name != "My favorite tracks")
                                {
                                    @if (track.IsFavorite)
                                    {
                                        <a href="#" class="m-1" title="Unmark as favorite" @onclick="@(() => ToggleFavorite(track))" @onclick:preventDefault><i class="bi @(track.IsFavorite ? "bi-star-fill" : "bi-star")"></i></a>
                                    }
                                    else
                                    {
                                        <a href="#" class="m-1" title="Mark as favorite" @onclick="@(() => ToggleFavorite(track))" @onclick:preventDefault><i class="bi @(track.IsFavorite ? "bi-star-fill" : "bi-star")"></i></a>
                                    }

                                }
                                @if (FavoritePlaylist.Name == "My favorite tracks")
                                {
                                    @if (track.IsFavorite)
                                    {
                                        <a href="#" class="m-1" title="Unmark as favorite" @onclick="@(() => ToggleFavorite(track))" @onclick:preventDefault><i class="bi @(track.IsFavorite ? "bi-star-fill" : "bi-star")"></i></a>
                                    }
                                    else
                                    {
                                        <a href="#" class="m-1" title="Mark as favorite" @onclick="@(() => ToggleFavorite(track))" @onclick:preventDefault><i class="bi @(track.IsFavorite ? "bi-star-fill" : "bi-star")"></i></a>
                                    }

                                }
                                <a href="#" class="m-1" title="Remove from this playlist" @onclick="@(() => RemoveTrack(track,FavoritePlaylist.Name))" @onclick:preventDefault><i class="bi bi-trash"></i></a>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

@code {
    [Parameter] public long PlaylistId { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthenticationState { get; set; }

    private Chinook.ClientModels.Playlist Playlist;
    private Chinook.Models.Playlist FavoritePlaylist;
    private List<Chinook.Models.Album> Album;
    private string CurrentUserId;
    private string InfoMessage;

    protected override async Task OnInitializedAsync()
    {
        CurrentUserId = await UserService.GetUserId(AuthenticationState);

        await InvokeAsync(StateHasChanged);

        FavoritePlaylist = PlaylistService.GetFavoritePlaylistByUser(PlaylistId, CurrentUserId).Result;

        Album = PlaylistService.GetAlbums().Result;
    }

    private void ToggleFavorite(Chinook.Models.Track track)
    {
        track.IsFavorite = !track.IsFavorite;

        if (track.IsFavorite)
        {
            this.FavoriteTrack(track);
        }
        else
        {
            this.UnfavoriteTrack(track);
        }
    }

    private async void FavoriteTrack(Chinook.Models.Track track)
    {
        var markedTrack = FavoritePlaylist.Tracks.FirstOrDefault(t => t.TrackId == track.TrackId);
        track.IsFavorite = true;
        var playlistName = "My favorite tracks";
        var favoritePlaylist = PlaylistService.GetPlaylistByName(playlistName).Result;
        var selectedTrack = ArtistService.GetTrackById(track.TrackId).Result;

        if (favoritePlaylist == null)
        {
            favoritePlaylist = new Chinook.Models.Playlist { Name = "My favorite tracks" };
            await PlaylistService.AddAsync(favoritePlaylist);
        }

        if (!favoritePlaylist.Tracks.Contains(selectedTrack))
        {
            selectedTrack.IsFavorite = true;
            favoritePlaylist.UserPlaylists = new List<UserPlaylist> { new UserPlaylist { UserId = CurrentUserId } };
            favoritePlaylist.Tracks.Add(selectedTrack);
            await PlaylistService.AddAsync(favoritePlaylist);
        }
        InfoMessage = $"Track {Album.Where(x => x.AlbumId == @track.AlbumId).Select(x => x.Artist.Name).FirstOrDefault()} - {Album.Where(x => x.AlbumId == @track.AlbumId).Select(x => x.Title).FirstOrDefault()} - {track.Name} added to playlist My favorite tracks.";
    }

    private async Task UnfavoriteTrack(Chinook.Models.Track track)
    {
        var markedTrack = FavoritePlaylist.Tracks.FirstOrDefault(t => t.TrackId == track.TrackId);
        track.IsFavorite = false;
        try
        {
            var existingTrack = await ArtistService.GetTrackById(track.TrackId);
            existingTrack.IsFavorite = false;
            var playlistName = "My favorite tracks";
            var existingPlaylist = await PlaylistService.GetPlaylistByName(playlistName);

            var addedPlaylistTracks = new Models.PlaylistTrack { PlaylistId = existingPlaylist.PlaylistId, TrackId = existingTrack.TrackId };

            var addedTrack = new Track
                {
                    Name = existingTrack.Name,
                    AlbumId = existingTrack.AlbumId,
                    Bytes = existingTrack.Bytes,
                    Composer = existingTrack.Composer,
                    GenreId = existingTrack.GenreId,
                    Album = existingTrack.Album,
                    Genre = existingTrack.Genre,
                    InvoiceLines = existingTrack.InvoiceLines,
                    IsFavorite = false,
                    MediaType = existingTrack.MediaType,
                    MediaTypeId = existingTrack.MediaTypeId,
                    Milliseconds = existingTrack.Milliseconds,
                    UnitPrice = existingTrack.UnitPrice,
                    PlaylistTracks = existingTrack.PlaylistTracks

                };

            existingPlaylist.Tracks.Add(existingTrack);
            existingPlaylist.PlaylistTracks.Add(addedPlaylistTracks);

            await ArtistService.CreateOrUpdatePlaylistTrackAsync(addedPlaylistTracks);
            await ArtistService.CreateOrUpdateTrackAsync(existingTrack, existingPlaylist.PlaylistId);

        }

        catch (Exception ex)
        {

        }
    }

    private async void RemoveTrack(Chinook.Models.Track track, string playlistName)
    {
        try
        {
            var selectedTrack = FavoritePlaylist.Tracks.FirstOrDefault(t => t.TrackId == track.TrackId);

            var favoritePlaylist = await PlaylistService.GetPlaylistByName(playlistName);

            var existingTrack = await ArtistService.GetTrackById(track.TrackId);

            if (favoritePlaylist.Tracks.Any())
            {
                var removeTrack = favoritePlaylist.Tracks.Where(x => x.TrackId == track.TrackId).FirstOrDefault();
                favoritePlaylist.Tracks.Remove(removeTrack);

                await PlaylistService.UpdateAsync(favoritePlaylist);
            }
            CloseInfoMessage();
        }

        catch(Exception ex)
        {

        }
        await CallNavBarInitialization();

    }

    private async Task CallNavBarInitialization()
    {
        NavMenuService.RequestReloadTestComponent();
    }

    private void CloseInfoMessage()
    {
        InfoMessage = "";
    }

}
